<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>MariaDB Status Diff</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <style>
      html {
        position: relative;
        min-height: 100%;
      }
      body {
        margin-bottom: 60px;
      }
      .footer {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 60px;
        background-color: #f5f5f5;
      }
      .container {
        width: auto;
        max-width: 680px;
        padding: 0 15px;
      }
      .container .text-muted {
        margin: 20px 0;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="page-header">
        <h1>MariaDB Status Diff</h1>
      </div>
      <p>
        <form class="form-inline" id="inputForm">
          <textarea id="inputBox" class="form-control" rows="3"></textarea>
          <div class="checkbox"><label><input id="showChanged" type="checkbox" checked> Only Show Changes</label></div>
          <button id="btnAdd" type="button" class="btn btn-default">Add</button>
        </form>
      </p>
      <table class="table table-hover" id="results">
         <tbody>
         </tbody>
       </table>
    </div>
  </body>
  <script type="text/javascript">
var keys = {};

function removeHeaders (lines) {
  var goodLines = [];
  lines.forEach(function (line) {
    if (line.length == 0) return;
    if (line.match(/^mysql>/)) return;
    if (line.match(/^\+-----/)) return;
    if (line.match(/^\| Variable_name/)) return;
    if (line.match(/sec\)$/)) return;
    if (line.match(/^\*\*\*\*\*/)) return;
    goodLines.push(line);
  });
  return goodLines;
};

function processLines (lines) {
  for (var i=0; i<lines.length; i++) {
    if (lines[i].substring(0,1) == '|') {
      var [ , key, value ] = lines[i].match(/^\|(.*)\|(.*)\|/);
      recordData(key, value);
    } else if (lines[i].substring(0,3) == 'Var') {
      var [ , key ] = lines[i].split(':');
      var [ , value ] = lines[i+1].split(':');
      recordData(key, value);
      i++;
    } else {
      console.log('Error parsing: '+lines[i]);
    }
  }
};

function recordData (key, value) {
  // Ignoring non-numeric values for now...
  if (isNaN(value)) return;

  key = key.trim();
  value = value.trim();

  if (keys[key]) {
    if (keys[key].min > value) keys[key].min = value;
    if (keys[key].max < value) keys[key].max = value;
    keys[key].count++;
  } else {
    keys[key] = {max: value, min: value, count: 1}
  }

  var row = document.getElementById(key);
  if (!row) {
    row = document.getElementById('results').insertRow();
    row.insertCell().appendChild(document.createTextNode(key));
    row.id = key;
  }
  var col = row.insertCell();
  col.id = `${keys[key].count}_${key}`;
  col.appendChild(document.createTextNode(value));

  if (keys[key].count > 1) {
    var prevVal = document.getElementById(`${keys[key].count-1}_${key}`).innerHTML;

    if (value > prevVal) col.style.backgroundColor = '#DDFFDD';
    if (value < prevVal) col.style.backgroundColor = '#FFDDDD';
  }

};

function showChanged () {
  for (var key in keys) {
    if (document.getElementById('showChanged').checked) {
      if (keys[key].max == keys[key].min) {
        document.getElementById(key).style.display = 'none';
      } else {
        document.getElementById(key).style.display = '';
      }
    } else {
       document.getElementById(key).style.display = '';
    }
  }
};

function start () {
  processLines(removeHeaders(document.getElementById('inputBox').value.trim().split('\n')));
  showChanged();
};

document.getElementById('btnAdd').addEventListener('click', start);
document.getElementById('showChanged').addEventListener('click', showChanged);
  </script>
</html>
